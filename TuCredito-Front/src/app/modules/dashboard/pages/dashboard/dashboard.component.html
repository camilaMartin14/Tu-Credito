<div class="dashboard-container">
  <!-- Header (Navbar is now in MainLayout) -->
  <header class="dashboard-header">
    <div class="header-info">
      <h1>Resumen Financiero</h1>
      <p *ngIf="lastUpdated()" class="last-updated">
        Actualizado: {{ lastUpdated() | date:'mediumTime' }}
      </p>
    </div>
    
    <div class="header-controls">
      <button class="btn-primary" (click)="navigateToRoute('/clients/new')">
        <span class="material-icons-round">person_add</span>
        Nuevo Cliente
      </button>

      <button class="btn-secondary" (click)="toggleFullDashboard()">
        <span class="material-icons-round">{{ showFullDashboard() ? 'visibility_off' : 'analytics' }}</span>
        {{ showFullDashboard() ? 'Ocultar Dashboard' : 'Ver Dashboard Completo' }}
      </button>

      <select [ngModel]="currentFilter()" (change)="onFilterChange($event)" class="filter-select">
        <option value="this_month">Este Mes</option>
        <option value="last_month">Mes Anterior</option>
        <option value="last_3_months">Últimos 3 Meses</option>
        <option value="this_year">Este Año</option>
        <option value="all">Histórico Completo</option>
      </select>

      <button class="btn-refresh" (click)="loadDashboardData()" [disabled]="isLoading()">
        <span class="material-icons-round" [class.spin]="isLoading()">refresh</span>
        <span *ngIf="!isLoading()">Actualizar</span>
        <span *ngIf="isLoading()">Cargando...</span>
      </button>
    </div>
  </header>

  <div class="alert alert-error" *ngIf="error()">
    {{ error() }}
  </div>

  <!-- Row 1: KPIs -->
  <section class="kpi-grid">
    <!-- KPI 1: Cobrado -->
    <div class="card kpi-card clickable" (click)="navigateToRoute('/payments')">
      <div class="kpi-icon">
        <span class="material-icons-round">attach_money</span>
      </div>
      <div class="kpi-content">
        <div class="kpi-title">
          Total Cobrado
          <button class="info-btn" aria-label="Información sobre Cobrado" (click)="$event.stopPropagation()">
            <span class="material-icons-round">info_outline</span>
            <span class="tooltip">Dinero efectivamente cobrado en pagos durante el período seleccionado. Si no se aplican filtros, muestra lo cobrado en el mes actual.</span>
          </button>
        </div>
        <div class="kpi-value success">{{ kpis()?.totalCobrado | currency:'USD':'symbol':'1.0-0' }}</div>
        <div class="kpi-subtitle">Total cobrado en el periodo</div>
      </div>
      <div class="kpi-decoration"></div>
    </div>

    <!-- KPI 2: Prestado -->
    <div class="card kpi-card clickable" (click)="navigateToRoute('/loans')">
      <div class="kpi-icon">
        <span class="material-icons-round">account_balance_wallet</span>
      </div>
      <div class="kpi-content">
        <div class="kpi-title">
          Total Prestado Histórico
          <button class="info-btn" aria-label="Información sobre Prestado" (click)="$event.stopPropagation()">
            <span class="material-icons-round">info_outline</span>
            <span class="tooltip">Monto total de dinero otorgado en préstamos dentro del período seleccionado (o histórico completo si no se aplican filtros).</span>
          </button>
        </div>
        <div class="kpi-value">{{ kpis()?.totalPrestadoHistorico | currency:'USD':'symbol':'1.0-0' }}</div>
        <div class="kpi-subtitle">Capital colocado</div>
      </div>
      <div class="kpi-decoration"></div>
    </div>

    <!-- KPI 3: Ganancia -->
    <div class="card kpi-card clickable" (click)="navigateToRoute('/payments')">
      <div class="kpi-icon">
        <span class="material-icons-round">trending_up</span>
      </div>
      <div class="kpi-content">
        <div class="kpi-title">
          Interés Cobrado
          <button class="info-btn" aria-label="Información sobre Ganancia" (click)="$event.stopPropagation()">
            <span class="material-icons-round">info_outline</span>
            <span class="tooltip">Monto estimado de intereses ya cobrados, calculado proporcionalmente sobre los pagos realizados.</span>
          </button>
        </div>
        <div class="kpi-value success">{{ kpis()?.totalInteresCobrado | currency:'USD':'symbol':'1.0-0' }}</div>
        <div class="kpi-subtitle">Intereses devengados</div>
      </div>
      <div class="kpi-decoration"></div>
    </div>

    <!-- KPI 4: Mora -->
    <div class="card kpi-card clickable" (click)="navigateToLoans('mora')">
      <div class="kpi-icon" style="color: var(--color-danger); background-color: #FFF5F5;">
        <span class="material-icons-round">warning</span>
      </div>
      <div class="kpi-content">
        <div class="kpi-title">
          Porcentaje de Morosidad
          <button class="info-btn" aria-label="Información sobre Mora" (click)="$event.stopPropagation()">
            <span class="material-icons-round">info_outline</span>
            <span class="tooltip">Proporción del capital en mora respecto del capital total pendiente.</span>
          </button>
        </div>
        <div class="kpi-value danger">{{ kpis()?.porcentajeMorosidad | number:'1.1-1' }}%</div>
        <div class="kpi-subtitle">Tasa de morosidad actual</div>
      </div>
      <div class="kpi-decoration"></div>
    </div>
  </section>

  <!-- Row 2: Operational Grid (Quick Actions + Calculator) -->
  <section class="operational-grid">
    <div class="card actions-card">
      <h3>Acciones Rápidas</h3>
      <div class="actions-container">
        <button class="action-btn primary">
          <span class="material-icons-round">add_circle</span>
          Nuevo Préstamo
        </button>
        <button class="action-btn success">
          <span class="material-icons-round">payments</span>
          Registrar Pago
        </button>
        <button class="action-btn secondary">
          <span class="material-icons-round">person_add</span>
          Nuevo Cliente
        </button>
      </div>
    </div>

    <div class="card calculator-card">
      <div class="calc-header">
        <div class="header-left">
          <h3>Simulador de Crédito</h3>
          <span class="material-icons-round">calculate</span>
        </div>
        <button class="btn-clear" (click)="clearCalculator()" title="Limpiar calculadora">
          <span class="material-icons-round">refresh</span>
        </button>
      </div>
      
      <div class="calc-display">
        <div class="display-label">Cuota Mensual Estimada</div>
        <div class="display-value">
            <span *ngIf="simResult(); else placeholder">{{ simResult()!.montoCuota | currency:'USD':'symbol':'1.2-2' }}</span>
            <ng-template #placeholder>$0.00</ng-template>
        </div>
        <div class="display-sub" *ngIf="simResult()">
             Total a pagar: {{ simResult()!.totalAPagar | currency:'USD':'symbol':'1.2-2' }}
        </div>
      </div>

      <div class="calculator-form">
        <div class="input-group">
          <label>Monto a Solicitar</label>
          <div class="input-wrapper">
            <span class="prefix">$</span>
            <input type="number" [(ngModel)]="simAmount" placeholder="0.00">
          </div>
        </div>
        
        <div class="row">
          <div class="input-group">
            <label>Cuotas</label>
            <input type="number" [(ngModel)]="simInstallments" placeholder="12">
          </div>
          <div class="input-group">
            <label>Tasa (%)</label>
            <input type="number" [(ngModel)]="simInterest" placeholder="5">
          </div>
        </div>

        <button class="btn-calculate" (click)="calculateLoan()" [disabled]="simLoading()">
            <span *ngIf="!simLoading()">Calcular Cuota</span>
            <div class="spinner-sm" *ngIf="simLoading()"></div>
        </button>
      </div>
    </div>
  </section>

  <ng-container *ngIf="!isLoading() && kpis()">
    <!-- Row 3: Charts (Only visible if showFullDashboard is true) -->
    <section class="charts-grid" *ngIf="showFullDashboard()">
      <!-- Flujo de Cobranzas -->
      <div class="card chart-card span-8">
        <div class="card-header">
          <div style="display: flex; align-items: center; gap: 8px;">
            <h3>Flujo de Cobranzas Mensual</h3>
            <button class="info-btn" aria-label="Información sobre Flujo de Cobranzas">
              <span class="material-icons-round">info_outline</span>
              <span class="tooltip">Dinero cobrado mes a mes en concepto de pagos de cuotas. Refleja el total efectivamente ingresado en cada mes, independientemente de cuándo se haya otorgado el préstamo.</span>
            </button>
          </div>
          <span class="material-icons-round" style="color: #A3AED0;">bar_chart</span>
        </div>
        <div class="chart-container">
          <canvas baseChart
            [data]="flujoCobranzasData"
            [options]="lineChartOptions"
            [type]="'line'">
          </canvas>
        </div>
      </div>

      <!-- Estado de Préstamos -->
      <div class="card chart-card span-4">
        <div class="card-header">
          <div style="display: flex; align-items: center; gap: 8px;">
            <h3>Préstamos por Estado</h3>
            <button class="info-btn" aria-label="Información sobre Estado de Préstamos">
              <span class="material-icons-round">info_outline</span>
              <span class="tooltip">Cantidad de préstamos según su estado actual. Permite identificar cuántos préstamos están activos, finalizados u en otros estados definidos en el sistema.</span>
            </button>
          </div>
          <span class="material-icons-round" style="color: #A3AED0;">pie_chart</span>
        </div>
        <div class="chart-container">
          <canvas baseChart
            [data]="prestamosEstadoData"
            [options]="doughnutChartOptions"
            [type]="'doughnut'">
          </canvas>
        </div>
      </div>

      <!-- Evolución Colocación -->
      <div class="card chart-card span-8">
        <div class="card-header">
          <div style="display: flex; align-items: center; gap: 8px;">
            <h3>Evolución de Colocación de Préstamos</h3>
            <button class="info-btn" aria-label="Información sobre Evolución de Colocación">
              <span class="material-icons-round">info_outline</span>
              <span class="tooltip">Evolución mensual del monto total otorgado en nuevos préstamos. Permite ver cómo fue creciendo o disminuyendo la colocación de dinero mes a mes dentro del período seleccionado.</span>
            </button>
          </div>
          <span class="material-icons-round" style="color: #A3AED0;">show_chart</span>
        </div>
        <div class="chart-container">
          <canvas baseChart
            [data]="evolucionColocacionData"
            [options]="lineChartOptions"
            [type]="'line'">
          </canvas>
        </div>
      </div>

      <!-- Composición Riesgo -->
      <div class="card chart-card span-4">
        <div class="card-header">
          <div style="display: flex; align-items: center; gap: 8px;">
            <h3>Composición del Riesgo</h3>
            <button class="info-btn" aria-label="Información sobre Composición de Riesgo">
              <span class="material-icons-round">info_outline</span>
              <span class="tooltip">Distribución del capital vencido según la antigüedad de la deuda. Agrupa las cuotas vencidas en rangos de días de atraso (1–30, 31–60, 61–90 y más de 90 días), mostrando el monto acumulado en cada tramo.</span>
            </button>
          </div>
          <span class="material-icons-round" style="color: #A3AED0;">donut_large</span>
        </div>
        <div class="chart-container">
          <canvas baseChart
            [data]="composicionRiesgoData"
            [options]="doughnutChartOptions"
            [type]="'doughnut'">
          </canvas>
        </div>
      </div>
      
      <!-- Proyección Flujo de Caja -->
      <div class="card chart-card span-6">
        <div class="card-header">
          <div style="display: flex; align-items: center; gap: 8px;">
            <h3>Proyección de Flujo de Caja</h3>
            <button class="info-btn" aria-label="Información sobre Proyección Flujo de Caja">
              <span class="material-icons-round">info_outline</span>
              <span class="tooltip">Estimación del dinero que debería ingresar en las próximas 4 semanas, basada en cuotas pendientes con vencimiento próximo. Cada barra representa el total a cobrar por semana, considerando únicamente cuotas pendientes con fecha de vencimiento futura.</span>
            </button>
          </div>
          <span class="material-icons-round" style="color: #A3AED0;">trending_up</span>
        </div>
        <div class="chart-container">
          <canvas baseChart
            [data]="proyeccionFlujoData"
            [options]="barChartOptions"
            [type]="'bar'">
          </canvas>
        </div>
      </div>

      <!-- Ranking Clientes -->
      <div class="card chart-card span-6">
        <div class="card-header">
          <div style="display: flex; align-items: center; gap: 8px;">
            <h3>Ranking de Clientes por Deuda</h3>
            <button class="info-btn" aria-label="Información sobre Ranking Clientes">
              <span class="material-icons-round">info_outline</span>
              <span class="tooltip">Top 10 de clientes con mayor capital adeudado actualmente. Considera únicamente préstamos activos y suma el capital pendiente (sin intereses) de cuotas pendientes y vencidas.</span>
            </button>
          </div>
          <span class="material-icons-round" style="color: #A3AED0;">leaderboard</span>
        </div>
        <div class="chart-container">
          <canvas baseChart
            [data]="rankingClientesData"
            [options]="barChartOptions"
            [type]="'bar'">
          </canvas>
        </div>
      </div>
      
      <!-- Evolución Saldo (Optional, if fits) -->
      <div class="card chart-card span-12">
        <div class="card-header">
          <div style="display: flex; align-items: center; gap: 8px;">
            <h3>Evolución del Saldo</h3>
            <button class="info-btn" aria-label="Información sobre Evolución de Saldo">
              <span class="material-icons-round">info_outline</span>
              <span class="tooltip">Evolución mensual del saldo financiero del sistema. El saldo se calcula acumulando: ingresos negativos por pagos recibidos, egresos positivos por préstamos otorgados. Permite visualizar si el capital disponible crece o se reduce en el tiempo.</span>
            </button>
          </div>
          <span class="material-icons-round" style="color: #A3AED0;">account_balance</span>
        </div>
        <div class="chart-container">
          <canvas baseChart
            [data]="evolucionSaldoData"
            [options]="lineChartOptions"
            [type]="'line'">
          </canvas>
        </div>
      </div>
    </section>
  </ng-container>

  <!-- Loading Overlay -->
  <div *ngIf="isLoading() && !kpis()" class="loading-state">
    <div class="spinner"></div>
    <p>Cargando indicadores financieros...</p>
  </div>
</div>
